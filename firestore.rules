rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAccountOwner(accountId) {
      return isAuthenticated() && request.auth.uid == accountId;
    }
    
    // 1. ACCOUNTS - Only user can read their own account
    match /accounts/{accountId} {
      allow read: if isAccountOwner(accountId);
      allow create: if isAccountOwner(accountId);
      allow update: if isAccountOwner(accountId);
      allow delete: if false; // Never delete accounts
    }
    
    // 2. USERS - Public profiles (readable by all authenticated users)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // 3. VERIFICATIONS - Users can create their own verifications
    match /verifications/{verificationId} {
      allow read: if isAuthenticated() && 
                     resource.data.accountId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.accountId == request.auth.uid;
      allow update, delete: if false; // Only Cloud Functions can update/delete
    }
    
    // 4. BANK ACCOUNTS - Private, user can only access their own
    match /bankAccounts/{accountId} {
      allow read: if isAccountOwner(accountId);
      allow create: if isAccountOwner(accountId);
      allow update: if isAccountOwner(accountId);
      allow delete: if false;
    }
    
    // 5. SWIPES - User can only create their own swipes
    match /swipes/{swipeId} {
      allow read: if isAuthenticated() && 
                     (resource.data.fromUserId == request.auth.uid || 
                      resource.data.toUserId == request.auth.uid);
      allow create: if isAuthenticated() && 
                       request.resource.data.fromUserId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // 6. MATCHES - Both users can read
    match /matches/{matchId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userA == request.auth.uid || 
                      resource.data.userB == request.auth.uid);
      allow write: if false; // Only Cloud Functions create matches
    }
    
    // 7. CHATS - Only participants can access
    match /chats/{chatId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      allow delete: if false;
    }
    
    // 8. MESSAGES - Only chat participants can access
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                       resource.data.senderId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.senderId == request.auth.uid;
    }
    
    // 9. GROUPS - Members can read, owner can update
    match /groups/{groupId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.members;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                       (request.auth.uid == resource.data.ownerId ||
                        request.auth.uid in resource.data.admins);
      allow delete: if isAuthenticated() && 
                       request.auth.uid == resource.data.ownerId;
    }
    
    // 10. EVENTS - Public read, creator can write
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                       resource.data.hostAccountId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.hostAccountId == request.auth.uid;
    }
    
    // 11. EVENT BOOKINGS - User can read their own bookings
    match /eventBookings/{bookingId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // 12. EVENT VERIFIERS - Only event host can manage
    match /eventVerifiers/{verifierId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions or admin
    }
    
    // 13. PAYMENTS - User can read their own payments
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only backend writes payments
    }
    
    // 14. LEDGER - Read-only for account owner
    match /ledger/{entryId} {
      allow read: if isAuthenticated() && 
                     resource.data.accountId == request.auth.uid;
      allow write: if false; // Only Cloud Functions
    }
    
    // 15. SETTLEMENTS - Creator can read their own
    match /settlements/{settlementId} {
      allow read: if isAuthenticated() && 
                     resource.data.accountId == request.auth.uid;
      allow write: if false; // Only Cloud Functions
    }
    
    // 16. REFUNDS - User can read their own refunds
    match /refunds/{refundId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // 17. CALL LOGS - Participants can read
    match /callLogs/{callId} {
      allow read: if isAuthenticated() && 
                     (resource.data.callerId == request.auth.uid || 
                      resource.data.receiverId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // 18. BLOCKED USERS - User can manage their own blocks
    match /blockedUsers/{blockId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    // 19. REPORTS - User can create reports
    match /reports/{reportId} {
      allow read: if false; // Only admins via Cloud Functions
      allow create: if isAuthenticated() && 
                       request.resource.data.reporterId == request.auth.uid;
      allow update, delete: if false; // Only admins
    }
    
    // 20. NOTIFICATIONS - User can read their own
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow create, delete: if false; // Only Cloud Functions
    }
    
    // 21. SUBSCRIPTIONS - User can read their own
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only backend
    }
    
    // 22. APP CONFIG - Public read, no write
    match /appConfig/{configId} {
      allow read: if true; // Public read for active configs
      allow write: if false; // Only admins via console
    }
  }
}
